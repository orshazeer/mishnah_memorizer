<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mishnah Fluency Pro</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #e0e0e0;
            --accent: #ccad00; /* Gold for Bartenura */
            --highlight: #4a90e2;
        }
        body {
            font-family: 'SBL Hebrew', 'Segoe UI', serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        #container {
            width: 90%;
            max-width: 800px;
            text-align: center;
            padding: 20px;
        }
        
        /* Setup Screen */
        #setup { margin-top: 50px; }
        select, button {
            padding: 12px 20px;
            font-size: 1.1rem;
            margin: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        button { background-color: var(--highlight); color: white; font-weight: bold; }
        button:hover { background-color: #357abd; }
        
        /* Main App */
        .hidden { display: none; }
        #nav-info { font-size: 1.2rem; color: #888; margin-bottom: 20px; }
        
        .mishnah-display {
            font-size: 2.5rem;
            line-height: 1.6;
            min-height: 100px;
            margin-bottom: 20px;
        }
        .highlight { color: var(--highlight); font-weight: bold; }

        /* Bartenura Box */
        #bartenura-peek {
            display: none; /* Hidden by default */
            background: var(--card);
            border-right: 5px solid var(--accent);
            padding: 20px;
            margin-top: 20px;
            text-align: right;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .bartenura-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            font-family: sans-serif;
        }
        #peek-content {
            font-size: 1.3rem;
            line-height: 1.5;
            color: #dcdcdc;
        }
        #peek-content b {
            color: var(--accent);
        }

        /* Controls */
        .controls { margin-top: 40px; border-top: 1px solid #444; padding-top: 20px; }
        .btn-control { background: #444; color: white; min-width: 100px; }
        
    </style>
</head>
<body>

<div id="container">
    <div id="setup">
        <h1>Mishnah Fluency</h1>
        <label>Choose Tractate:</label>
        <select id="tractateSelect">
            <option value="Berakhot">Berakhot (ברכות)</option>
            <option value="Peah">Peah (פאה)</option>
            <option value="Demai">Demai (דמאי)</option>
            <option value="Kilayim">Kilayim (כלאים)</option>
            <option value="Sheviit">Sheviit (שביעית)</option>
            <option value="Terumot">Terumot (תרומות)</option>
            <option value="Maasrot">Maasrot (מעשרות)</option>
            <option value="MaaserSheni">Maaser Sheni (מעשר שני)</option>
            <option value="Challah">Challah (חלה)</option>
            <option value="Orlah">Orlah (ערלה)</option>
            <option value="Bikkurim">Bikkurim (ביכורים)</option>
        </select>
        <br>
        <button onclick="startApp()">Start Learning</button>
    </div>

    <div id="app" class="hidden">
        <div id="nav-info">Loading...</div>
        <div class="mishnah-display" id="display"></div>
        
        <div id="bartenura-peek">
            <span class="bartenura-label">פירוש הברטנורא (Bartenura Commentary)</span>
            <div id="peek-content"></div>
        </div>

        <div class="controls">
            <button class="btn-control" onclick="prevStep()">Back (←)</button>
            <button class="btn-control" id="mainBtn" onclick="nextStep()">Next (Space)</button>
        </div>
    </div>
</div>

<script>
    // State Variables
    let currentTractate = "";
    let mishnahData = []; // Array of Arrays [Chapter][Mishnah] -> String text
    let bartenuraFullText = ""; 
    
    // Navigation Pointers
    let pIdx = 0; // Perek Index (0-based)
    let mIdx = 0; // Mishnah Index (0-based)
    let sIdx = 0; // Sentence/Part Index
    let parts = []; // The parts of the current Mishnah
    let mode = "learning"; // 'learning' (parts), 'sentence' (full), 'review'

    // 1. Initialize and Load Files
    async function startApp() {
        const select = document.getElementById('tractateSelect');
        currentTractate = select.value;

        // Hide setup, show app
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');

        try {
            // A. Load Hebrew Mishnah Text
            const mRes = await fetch(`./Clean_Mishnah/${currentTractate}.txt`);
            if (!mRes.ok) throw new Error("Mishnah file not found");
            const mText = await mRes.text();
            parseMishnahText(mText);

            // B. Load Bartenura Text
            const bRes = await fetch(`./Bartenura/Bartenura_${currentTractate}.txt`);
            if (bRes.ok) {
                bartenuraFullText = await bRes.text();
            } else {
                console.warn("Bartenura file not found for this tractate");
            }

            // Start Logic
            loadCurrentMishnah();

        } catch (e) {
            alert("Error loading files. Please check console or file names.");
            console.error(e);
        }
    }

    // Parse the Hebrew Mishnah text into [Chapter][Mishnah] structure
    function parseMishnahText(text) {
        // Assumes file format: "פרק א" splits chapters, "משנה א" splits mishnahs
        const chapters = text.split(/פרק\s+[א-ת]+/);
        mishnahData = chapters.filter(c => c.trim().length > 0).map(chapter => {
            return chapter.split(/משנה\s+[א-ת]+/).filter(m => m.trim().length > 0);
        });
    }

    // 2. Navigation Logic
    function loadCurrentMishnah() {
        if (!mishnahData[pIdx] || !mishnahData[pIdx][mIdx]) {
            alert("End of Tractate!");
            return;
        }
        
        const fullText = mishnahData[pIdx][mIdx].trim();
        // Split by punctuation for learning mode
        parts = fullText.split(/([:;.,]|\s+ו-)/).filter(x => x.trim().length > 0);
        
        sIdx = 0;
        mode = "learning";
        updateDisplay();
    }

    function updateDisplay() {
        const display = document.getElementById('display');
        const info = document.getElementById('nav-info');
        const bartenuraBox = document.getElementById('bartenura-peek');

        info.innerText = `${currentTractate} | Perek ${pIdx+1} | Mishnah ${mIdx+1}`;

        if (mode === "learning") {
            // Show just the current phrase
            const currentText = parts[sIdx];
            display.innerHTML = `<span class="highlight">${currentText}</span>`;
            
            // Trigger Bartenura Sync
            syncBartenura(currentText);

        } else if (mode === "sentence") {
            // Show full text
            display.innerText = mishnahData[pIdx][mIdx];
            bartenuraBox.style.display = 'none'; // Hide commentary in review mode
        }
    }

    function nextStep() {
        if (mode === "learning") {
            sIdx++;
            if (sIdx >= parts.length) {
                mode = "sentence";
            }
        } else {
            // Move to next Mishnah
            mIdx++;
            if (!mishnahData[pIdx][mIdx]) {
                // Next Chapter
                pIdx++;
                mIdx = 0;
                if (!mishnahData[pIdx]) {
                    alert("Finished Tractate!");
                    return;
                }
            }
            loadCurrentMishnah();
        }
        updateDisplay();
    }

    function prevStep() {
        if (mode === "sentence") {
            mode = "learning";
            sIdx = parts.length - 1;
        } else if (sIdx > 0) {
            sIdx--;
        }
        updateDisplay();
    }

    // 3. The Smart Bartenura Logic
    function syncBartenura(hebrewPhrase) {
        const bartenuraBox = document.getElementById('bartenura-peek');
        const contentDiv = document.getElementById('peek-content');
        
        if (!bartenuraFullText || !hebrewPhrase) {
            bartenuraBox.style.display = 'none';
            return;
        }

        // 1. Isolate the correct Chapter and Mishnah in the Bartenura file
        // The file uses "Chapter 1" and "Mishnah 1" in English
        const chapterSplit = bartenuraFullText.split(new RegExp(`Chapter\\s+${pIdx + 1}`));
        if (chapterSplit.length < 2) return; 

        const currentChapterText = chapterSplit[1];
        const mishnahSplit = currentChapterText.split(new RegExp(`Mishnah\\s+${mIdx + 1}`));
        
        // Safety check: ensure we found the mishnah and cut off before the next one
        if (mishnahSplit.length < 2) {
            bartenuraBox.style.display = 'none'; 
            return;
        }
        
        // Limit text to just this Mishnah (stop at next "Mishnah" or "Chapter")
        let relevantText = mishnahSplit[1].split(/Mishnah\s+\d+|Chapter\s+\d+/)[0];

        // 2. Find the Match
        // We look for <b>Header</b>Content...
        const regex = /<b>(.*?)<\/b>(.*?)(?=<b>|$)/gs;
        
        // Clean the search phrase (remove vowels for better matching)
        const cleanSearch = hebrewPhrase.replace(/[\u0591-\u05C7]/g, "").trim();
        
        let match;
        let found = false;

        while ((match = regex.exec(relevantText)) !== null) {
            const boldHeader = match[1]; // The text inside <b>
            const explanation = match[2]; // The text after </b>
            
            // Clean the header from the file to compare
            const cleanHeader = boldHeader.replace(/[\u0591-\u05C7]/g, "");

            // LOGIC: If the user's phrase is inside the Header, OR the Header is inside the phrase
            if (cleanHeader.includes(cleanSearch) || cleanSearch.includes(cleanHeader)) {
                // Only show if the match is significant (more than 2 letters) to avoid false positives
                if (cleanSearch.length > 2) {
                    contentDiv.innerHTML = `<b>${boldHeader}</b>${explanation}`;
                    bartenuraBox.style.display = 'block';
                    found = true;
                    break; 
                }
            }
        }

        if (!found) {
            bartenuraBox.style.display = 'none';
        }
    }

    // Keyboard Shortcuts
    window.addEventListener('keydown', (e) => {
        if (e.code === "Space") {
            e.preventDefault();
            nextStep();
        } else if (e.code === "ArrowLeft") {
            prevStep();
        }
    });

</script>

</body>
</html>
